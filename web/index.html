<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nexio Chat</title>
  <style>
    :root {
      --color-black: #000;
      --color-white: #f8f8f8;
      --color-success: #44ff88;
      --color-warning: #ffdd44;
      --color-danger: #ff4444;
      --color-info: #44ddff;
      --card: #fff;
      --muted: #555;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--color-white);
      color: var(--color-black);
      line-height: 1.6;
    }
    header {
      padding: 24px 20px;
      border-bottom: 2px solid var(--color-black);
      box-shadow: 0 4px 0 rgba(0,0,0,0.1);
      background: #fff;
    }
    .brand { max-width: 1080px; margin: 0 auto; display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: 0.05em; }
    .badge { padding: 6px 12px; border: 2px solid var(--color-black); background: var(--color-info); box-shadow: -4px 4px 0 rgba(0,0,0,0.15); font-weight: 700; }
    .container { max-width: 1080px; margin: 0 auto; padding: 24px 20px 40px; display: flex; flex-direction: column; gap: 20px; }
    .hidden { display: none; }
    .card { background: var(--card); border: 2px solid var(--color-black); box-shadow: -8px 8px 0 rgba(0,0,0,0.15); padding: 20px; }
    .grid { display: grid; gap: 16px; }
    form { display: flex; flex-direction: column; gap: 14px; }
    input, button, textarea { font: inherit; }
    label { font-weight: 700; font-size: 14px; }
    input, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--color-black);
      background: #fff;
      outline: none;
      transition: all 0.2s ease;
    }
    input:focus, textarea:focus {
      box-shadow: -4px 4px 0 rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    textarea { min-height: 72px; resize: vertical; }
    .btn {
      padding: 12px 18px;
      border: 2px solid var(--color-black);
      cursor: pointer;
      font-weight: 800;
      text-transform: uppercase;
      background: #000;
      color: #fff;
      transition: all 0.2s ease;
      box-shadow: -6px 6px 0 rgba(0,0,0,0.2);
    }
    .btn.secondary { background: #fff; color: #000; }
    .btn.danger { background: var(--color-danger); color: #000; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
    .btn:not(:disabled):hover { transform: translate(-2px, -2px); box-shadow: -8px 8px 0 rgba(0,0,0,0.25); }
    .tabs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 14px; }
    .tab { text-align: center; padding: 12px; border: 2px solid var(--color-black); background: #fff; font-weight: 800; cursor: pointer; box-shadow: -4px 4px 0 rgba(0,0,0,0.15); }
    .tab.active { background: var(--color-info); }
    .error { color: var(--color-danger); font-size: 14px; min-height: 18px; font-weight: 700; }
    .password-strength { height: 10px; border: 2px solid var(--color-black); background: #fff; box-shadow: inset -4px 4px 0 rgba(0,0,0,0.05); }
    .password-strength span { display: block; height: 100%; width: 0%; transition: width .2s ease, background-color .2s ease; background: var(--color-danger); }
    .chat-wrapper { display: grid; grid-template-columns: 1fr 280px; gap: 16px; align-items: start; }
    .chat-box { height: 70vh; display: flex; flex-direction: column; gap: 12px; }
    .panel { border: 2px solid var(--color-black); background: #fff; box-shadow: -6px 6px 0 rgba(0,0,0,0.12); }
    .messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
    .message { display: grid; grid-template-columns: 48px 1fr; gap: 12px; align-items: start; border: 2px solid var(--color-black); padding: 12px; background: #fdfdfd; box-shadow: -4px 4px 0 rgba(0,0,0,0.1); }
    .bubble { background: #fff; border: 2px solid var(--color-black); padding: 10px 12px; box-shadow: -4px 4px 0 rgba(0,0,0,0.12); }
    .avatar { width: 48px; height: 48px; border-radius: 50%; border: 2px solid var(--color-black); display: grid; place-items: center; font-weight: 800; background: #fff; }
    .bubble header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 14px; color: var(--muted); font-weight: 700; }
    .bubble .content { word-break: break-word; white-space: pre-wrap; font-weight: 600; }
    .bubble img { max-width: 100%; border: 2px solid var(--color-black); box-shadow: -4px 4px 0 rgba(0,0,0,0.12); margin-top: 6px; }
    .bubble a { color: var(--color-black); border-bottom: 2px solid var(--color-black); text-decoration: none; font-weight: 700; }
    .composer { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
    .uploads { display: flex; gap: 10px; align-items: center; }
    .online { padding: 16px; }
    .online h3 { margin: 0 0 12px; font-size: 16px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; }
    .online ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; max-height: 40vh; overflow-y: auto; }
    .pill { display: inline-block; padding: 8px 12px; border: 2px solid var(--color-black); background: #fff; font-weight: 800; box-shadow: -4px 4px 0 rgba(0,0,0,0.12); }
    .status { display: flex; align-items: center; gap: 10px; }
    .status .dot { width: 12px; height: 12px; background: var(--color-success); border: 2px solid var(--color-black); box-shadow: -2px 2px 0 rgba(0,0,0,0.1); }
    @media (max-width: 960px) {
      .chat-wrapper { grid-template-columns: 1fr; }
      .chat-box { height: auto; }
      header { text-align: center; }
      .brand { justify-content: center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="badge">LAN CHAT</div>
      <div>
        <div style="font-size:24px; font-weight:900;">NEXIO 公共频道</div>
        <div style="font-weight:700; color: var(--muted);">无装饰 · 粗犷 · 直达功能</div>
      </div>
    </div>
  </header>
  <div class="container">
    <div id="auth" class="card">
      <div class="tabs">
        <div class="tab active" data-tab="login">登陆</div>
        <div class="tab" data-tab="register">注册</div>
      </div>
      <div id="login-view">
        <form id="login-form">
          <label>用户名</label>
          <input name="username" placeholder="长度 5-15，仅字母与数字" minlength="5" maxlength="15" required>
          <label>密码</label>
          <input name="password" type="password" placeholder="长度 6-32" minlength="6" maxlength="32" required>
          <div class="error" id="login-error"></div>
          <button type="submit" class="btn">登陆</button>
        </form>
      </div>
      <div id="register-view" class="hidden">
        <form id="register-form">
          <label>用户名</label>
          <input name="username" placeholder="5-15 位字母或数字" minlength="5" maxlength="15" required>
          <label>密码</label>
          <input name="password" type="password" placeholder="至少两种字符组合" minlength="6" maxlength="32" required>
          <label>确认密码</label>
          <input name="confirm" type="password" placeholder="再次输入密码" minlength="6" maxlength="32" required>
          <div class="password-strength"><span id="strength-bar"></span></div>
          <div class="error" id="register-error"></div>
          <button type="submit" class="btn">注册</button>
        </form>
      </div>
    </div>

    <div id="chat" class="hidden">
      <div class="card" style="display:flex; align-items:center; gap:12px;">
        <div class="status"><span class="dot"></span><span class="pill">公共频道 · <span id="online-count">0</span> 人在线</span></div>
        <button id="logout" class="btn secondary" style="margin-left:auto;">退出</button>
      </div>
      <div class="chat-wrapper">
        <div class="chat-box card">
          <div class="messages panel" id="messages"></div>
          <div class="composer">
            <textarea id="message-input" placeholder="输入消息..." maxlength="500"></textarea>
            <button id="send" class="btn">发送</button>
          </div>
          <div class="uploads">
            <input type="file" id="file-input">
            <button id="upload" class="btn secondary">上传文件/图片</button>
            <div class="error" id="action-error"></div>
          </div>
        </div>
        <div class="online card">
          <h3>在线用户 <span id="online-count-side">0</span></h3>
          <ul id="online-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const authCard = document.getElementById('auth');
    const chatView = document.getElementById('chat');
    const tabs = document.querySelectorAll('.tab');
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');
    const strengthBar = document.getElementById('strength-bar');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send');
    const messagesEl = document.getElementById('messages');
    const onlineCount = document.getElementById('online-count');
    const onlineCountSide = document.getElementById('online-count-side');
    const onlineList = document.getElementById('online-list');
    const uploadBtn = document.getElementById('upload');
    const fileInput = document.getElementById('file-input');
    const actionError = document.getElementById('action-error');
    const logoutBtn = document.getElementById('logout');

    let eventSource = null;
    let currentUser = '';
    let messages = [];

    tabs.forEach(tab => tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      if (tab.dataset.tab === 'login') {
        loginView.classList.remove('hidden');
        registerView.classList.add('hidden');
      } else {
        registerView.classList.remove('hidden');
        loginView.classList.add('hidden');
      }
    }));

    registerForm.password.addEventListener('input', (e) => {
      const score = passwordStrengthScore(e.target.value);
      strengthBar.style.width = `${score}%`;
      const color = score > 70 ? '#34d399' : score > 40 ? '#fbbf24' : '#ef4444';
      strengthBar.style.backgroundColor = color;
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const payload = {
        username: loginForm.username.value.trim(),
        password: loginForm.password.value,
      };
      try {
        await request('/login', payload);
        await loadUser();
      } catch (err) {
        loginError.textContent = err.message;
      }
    });

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      registerError.textContent = '';
      const payload = {
        username: registerForm.username.value.trim(),
        password: registerForm.password.value,
        passwordConfirm: registerForm.confirm.value,
      };
      try {
        await request('/register', payload, 'POST', true);
        await loadUser();
      } catch (err) {
        registerError.textContent = err.message;
      }
    });

    sendBtn.addEventListener('click', async () => {
      if (!messageInput.value.trim()) return;
      try {
        sendBtn.disabled = true;
        const res = await request('/message', { content: messageInput.value.trim() });
        messageInput.value = '';
      } catch (err) {
        actionError.textContent = err.message;
      } finally {
        setTimeout(() => sendBtn.disabled = false, 300);
      }
    });

    uploadBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) {
        actionError.textContent = '请选择文件';
        return;
      }
      actionError.textContent = '';
      const form = new FormData();
      form.append('file', fileInput.files[0]);
      uploadBtn.disabled = true;
      try {
        await fetch('/upload', { method: 'POST', body: form });
        fileInput.value = '';
      } catch (err) {
        actionError.textContent = '上传失败';
      } finally {
        uploadBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await fetch('/logout', { method: 'POST' });
      stopStream();
      toggleViews(false);
    });

    function passwordStrengthScore(password) {
      let score = 0;
      if (password.length >= 6) score += Math.min(password.length * 5, 40);
      const checks = [/[a-z]/, /[A-Z]/, /[0-9]/, /[^A-Za-z0-9]/];
      score += checks.filter(r => r.test(password)).length * 15;
      return Math.min(100, score);
    }

    function toggleViews(authed) {
      if (authed) {
        authCard.classList.add('hidden');
        chatView.classList.remove('hidden');
      } else {
        authCard.classList.remove('hidden');
        chatView.classList.add('hidden');
        messages = [];
        renderMessages();
      }
    }

    async function loadUser() {
      try {
        const res = await fetch('/me');
        if (!res.ok) throw new Error('未登陆');
        const data = await res.json();
        currentUser = data.username;
        toggleViews(true);
        startStream();
      } catch (err) {
        toggleViews(false);
      }
    }

    function startStream() {
      stopStream();
      eventSource = new EventSource('/stream');
      eventSource.onmessage = (event) => {
        const payload = JSON.parse(event.data);
        if (payload.type === 'history') {
          messages = payload.messages || [];
          renderMessages();
        } else if (payload.type === 'message' && payload.message) {
          messages.push(payload.message);
          trimMessages();
          renderMessages(true);
        } else if (payload.type === 'online') {
          updateOnline(payload.users || []);
        } else if (payload.type === 'error') {
          actionError.textContent = payload.error;
        }
      };
      eventSource.onerror = () => {
        actionError.textContent = '连接中断，正在重试...';
      };
    }

    function stopStream() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
    }

    function updateOnline(users) {
      onlineCount.textContent = users.length;
      onlineCountSide.textContent = users.length;
      onlineList.innerHTML = '';
      users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u;
        onlineList.appendChild(li);
      });
    }

    function avatarLetter(name) {
      return name ? name.charAt(0).toUpperCase() : '?';
    }

    function renderMessages(scrollToBottom = false) {
      messagesEl.innerHTML = '';
      messages.forEach(msg => {
        const item = document.createElement('div');
        item.className = 'message';
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = avatarLetter(msg.username);
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const header = document.createElement('header');
        const name = document.createElement('span');
        name.textContent = msg.username;
        const time = document.createElement('span');
        time.textContent = new Date(msg.createdAt).toLocaleTimeString();
        header.appendChild(name); header.appendChild(time);
        const content = document.createElement('div');
        content.className = 'content';
        if (msg.kind === 'image' && msg.fileUrl) {
          const img = document.createElement('img');
          img.src = msg.fileUrl;
          img.alt = msg.fileName || 'image';
          content.appendChild(img);
        } else if (msg.kind === 'file' && msg.fileUrl) {
          const link = document.createElement('a');
          link.href = msg.fileUrl;
          link.textContent = msg.fileName || '文件';
          link.target = '_blank';
          content.appendChild(link);
        } else {
          content.textContent = msg.content;
        }
        bubble.appendChild(header);
        bubble.appendChild(content);
        item.appendChild(avatar);
        item.appendChild(bubble);
        messagesEl.appendChild(item);
      });
      if (scrollToBottom) {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }

    function trimMessages() {
      if (messages.length > 120) {
        messages = messages.slice(-120);
      }
    }

    async function request(url, data = {}, method = 'POST', throwOnError = true) {
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      const text = await res.text();
      if (!res.ok && throwOnError) {
        throw new Error(text || '请求失败');
      }
      try {
        return text ? JSON.parse(text) : {};
      } catch (e) {
        return {};
      }
    }

    loadUser();
  </script>
</body>
</html>
